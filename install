#!/usr/bin/env bash

set -eu
################################################################################
# Update submodules.
################################################################################
echo -e "Update submodules"
git submodule update --init

################################################################################
# Install brew (for macos)
################################################################################
if ! command -v brew && [[ $(uname) == "Darwin" ]]; then
  echo "Installing brew..."
  /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
fi

################################################################################
# Stow dotfiles
################################################################################
if ! command -v stow && [[ $(uname) == "Darwin" ]]; then
  echo -e "\\nInstalling stow..."
  brew install stow
fi

# Use stow to populate dotfiles
echo -e "Populating dotfiles...\\n"
for i in */; do
  echo "Stowing $i ..."
  stow -R "$i"
done

################################################################################
# Install vim Plug
################################################################################
echo -e "\\nInstalling vim Plug ..."
curl -fLo ~/.vim/autoload/plug.vim --create-dirs \
  https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim

# Install vim plugins and quit
nvim +PlugInstall +qa

################################################################################
# Install completions
################################################################################
completion_dir="./zsh/completions"
echo -e "\\nInstall github hub completion"
curl -L https://raw.githubusercontent.com/github/hub/master/etc/hub.zsh_completion \
  -o $completion_dir/_hub

################################################################################
# home-manager
################################################################################
# Install nix; home-manager
if ! command -v nix; then
  echo "Installing nix..."
  curl -L https://nixos.org/nix/install | sh
fi

# Use unstable channel
nix-channel --add https://nixos.org/channels/nixpkgs-unstable
nix-channel --add https://github.com/rycee/home-manager/archive/master.tar.gz home-manager
nix-channel --update

if ! command -v home-manager; then
  echo "Installing home-manager..."
  nix-shell '<home-manager>' -A install
fi

########################################
# Install nnn plugins
########################################
curl -Ls https://raw.githubusercontent.com/jarun/nnn/master/plugins/getplugs | sh

################################################################################
# DONE
################################################################################
echo -e "\\nDone!"
